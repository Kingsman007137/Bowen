# 任务：项目初始化与重构

## 任务信息

- **任务名称**: 项目初始化与重构 (Project Initialization & Refactor)
- **创建时间**: 2025-01-25
- **更新时间**: 2025-01-26
- **优先级**: 高
- **状态**: 已完成核心功能

## 任务概述

本任务完成了基于原型图的项目重构，从零搭建了完整的多页面卡片笔记应用。项目采用 Next.js 15 + TailwindCSS 4 技术栈，实现了登录页、笔记架页和画布页三个核心页面，并建立了完整的状态管理和数据持久化方案。

**核心架构：**
- **多页面应用**：登录页 → 笔记架页 → 画布页的页面流转
- **状态管理**：基于 Zustand 的笔记本和画布状态管理
- **数据持久化**：基于 IndexedDB（localforage）的画布数据存储 + localStorage 的笔记本数据存储
- **主题系统**：白天/黑夜模式切换，全局主题管理
- **无限画布**：基于 React Flow 实现的可缩放、平移的无限画布

**实现依据：**
- `prototypes/notebook-shelf.html` - 笔记架页面原型
- `prototypes/canvas.html` - 画布页面原型
- `prototypes/login.html` - 登录页面原型
- `docs/产品需求文档.md` - 功能需求文档
- `docs/视觉规范文档.md` - 视觉设计规范

## 实现内容

### 一、项目架构搭建

#### 1.1 页面路由结构
已完成三个核心页面的路由配置：
- **登录页面** (`app/(auth)/login/page.tsx`)：实现伪登录功能，用户输入任意用户名即可进入系统
- **笔记架页面** (`app/(main)/shelf/page.tsx`)：展示所有笔记本和文件夹的网格布局
- **画布页面** (`app/(main)/canvas/[id]/page.tsx`)：动态路由，根据笔记本 ID 加载对应的卡片画布
- **主布局** (`app/(main)/layout.tsx`)：侧边栏布局，包含导航和操作按钮

#### 1.2 组件目录结构
按功能模块组织了组件目录：
- **Canvas 组件**：`CanvasContainer.tsx`（画布容器）、`CardNode.tsx`（卡片节点）、`CardEditModal.tsx`（卡片编辑弹窗）、`MiniMapPanel.tsx`（小地图）、`ZoomControls.tsx`（缩放控制）
- **Shelf 组件**：`NoteCard.tsx`（笔记卡片）、`FolderCard.tsx`（文件夹卡片）
- **Editor 组件**：`TiptapEditor.tsx`（富文本编辑器）、`ImageUploader.tsx`（图片上传）
- **UI 组件**：`Sidebar.tsx`（侧边栏）、`Toolbar.tsx`（工具栏）、`Toast.tsx`（提示）、`ConfirmDialog.tsx`（确认对话框）、`InputDialog.tsx`（输入对话框）、`ColorPicker.tsx`（颜色选择器）

#### 1.3 数据模型
创建了完整的 TypeScript 类型定义：
- `types/notebook.ts`：笔记本数据结构（包含 ID、名称、文件夹归属、卡片数量、渐变色键、时间戳）
- `types/folder.ts`：文件夹数据结构（包含 ID、名称、笔记数量、创建时间）
- `types/card.ts`：卡片数据结构（包含 ID、笔记本归属、位置、大小、标题、内容、颜色、时间戳）
- `types/connection.ts`：连线数据结构（包含 ID、笔记本归属、起点卡片 ID、终点卡片 ID、连线类型）

### 二、视觉系统实现

#### 2.1 常量配置 (constants.ts)
定义了完整的视觉系统常量：
- **笔记本渐变色**：10 种渐变配色方案（蓝、紫、粉、橙、绿、青、天蓝、靛蓝、玫红、琥珀）
- **卡片渐变色**：区分明暗主题的 3 种卡片渐变（海雾蓝、柔粉金、薄荷绿）
- **主题颜色**：主色调 `#137fec`，背景色配置
- **画布参数**：默认缩放比例、最小/最大缩放、缩放步进
- **卡片默认值**：宽度 400px、最小高度 200px、圆角、阴影、透明度等

#### 2.2 主题样式 (globals.css & theme.css)
实现了完整的主题系统：
- **CSS 变量**：定义了 `--primary`、`--bg-light`、`--bg-dark` 等主题变量
- **暗色模式**：通过 `.dark` 类切换，所有组件响应主题变化
- **Material Symbols**：集成 Google 图标字体，使用 Outlined 和 Rounded 两种变体
- **自定义样式类**：`.glass-card`（毛玻璃效果）、`.shelf-divider`（分割线）、`.folder-icon-3d`（3D 文件夹图标）

#### 2.3 TailwindCSS 配置
使用 TailwindCSS 4 的 `@theme` 语法定义自定义颜色和配置，启用 `class` 模式的暗色主题切换。

### 三、状态管理系统

#### 3.1 Zustand Store
创建了三个核心状态管理器：

**笔记本状态** (`hooks/useNotebookStore.ts`)：
- 管理笔记本和文件夹列表
- 提供 CRUD 操作（新建、更新、删除、查询）
- 自动同步到 localStorage
- 维护文件夹与笔记本的关联关系

**画布状态** (`hooks/useCanvasStore.ts`)：
- 管理当前笔记本的卡片和连线
- 支持三种画布模式：选择（select）、拖动（pan）、连线（connect）
- 提供卡片和连线的 CRUD 操作
- 管理连线模式的临时状态
- 自动保存画布数据到 IndexedDB

**主题状态** (`hooks/useTheme.ts`)：
- 管理明暗主题切换
- 持久化主题偏好到 localStorage
- 初始化时读取系统偏好或已保存偏好

#### 3.2 数据流设计
- **笔记本数据**：通过 `useNotebookStore` 管理，存储在 localStorage
- **画布数据**：通过 `useCanvasStore` 管理，存储在 IndexedDB（使用 localforage）
- **主题偏好**：通过 `useTheme` 管理，存储在 localStorage

### 四、数据持久化方案

#### 4.1 存储模块 (storage.ts)
基于 localforage 封装了 IndexedDB 操作：
- `saveCanvasState()`：保存笔记本的卡片和连线数据
- `loadCanvasState()`：加载笔记本的画布数据
- `clearCanvasState()`：清空画布数据
- `deleteNotebookCanvas()`：删除笔记本时清理画布数据
- `getStorageInfo()`：查询存储空间使用情况

#### 4.2 示例数据 (seedData.ts)
提供了初始化示例数据的函数，首次启动时自动创建示例笔记本和文件夹，方便用户快速体验功能。

### 五、核心页面实现

#### 5.1 登录页面
- 背景图片 + 毛玻璃效果
- 主题切换按钮（右上角）
- 用户名输入框 + 登录按钮
- 伪登录逻辑（保存到 localStorage）
- 自动初始化示例数据

#### 5.2 笔记架页面
**侧边栏功能**：
- Logo 和主题切换按钮
- 新建笔记按钮
- 新建文件夹按钮
- 导航链接（所有笔记）
- 用户信息展示

**主内容区**：
- 顶部标题 + 搜索框
- 文件夹网格区域（3D 立体图标、笔记数量统计）
- 笔记网格区域（渐变封面、卡片数量、更新时间）
- 悬停动画（上浮效果）
- 卡片操作菜单（重命名、删除）

**交互模态框**：
- 新建笔记模态框（输入名称后自动跳转到画布）
- 新建文件夹模态框
- 确认删除对话框
- 重命名输入对话框
- Toast 提示反馈

#### 5.3 画布页面
**工具栏功能**：
- 返回笔记架按钮
- 笔记本名称显示
- 模式切换按钮组（选择/拖动/连线）
- 新建卡片按钮（双击画布也可创建）
- 居中按钮
- 主题切换按钮
- 自动保存指示

**画布容器**：
- 基于 React Flow 的无限画布
- 网格背景（响应主题变化）
- 支持鼠标滚轮缩放
- 支持拖动画布（拖动模式）
- 支持框选（选择模式）

**卡片节点**：
- 毛玻璃效果卡片
- 标题 + 内容预览
- 悬停显示操作按钮（编辑/删除）
- 支持拖动（选择模式）
- 支持连线（连线模式）
- 响应主题变化

**辅助功能**：
- 小地图面板（可切换显隐）
- 缩放控制条
- 连线模式提示
- 卡片编辑弹窗（Tiptap 富文本编辑器 + 颜色选择器 + 图片上传）

### 六、核心功能实现

#### 6.1 笔记架功能
✅ 新建笔记（自动分配渐变色，创建后跳转到画布）
✅ 删除笔记（带确认提示，同步删除画布数据）
✅ 重命名笔记（通过输入对话框）
✅ 点击笔记进入画布

#### 6.2 文件夹功能
✅ 新建文件夹
✅ 删除文件夹（笔记移至根目录）
✅ 重命名文件夹
⏸ 点击文件夹过滤笔记（待实现）

#### 6.3 画布交互
✅ 三种模式切换（选择/拖动/连线）
✅ 选择模式：拖动卡片、框选
✅ 拖动模式：拖动画布、滚轮缩放
✅ 连线模式：点击两个卡片创建连线
✅ 双击画布创建卡片
✅ 居中功能（fitView）
✅ 缩放控制（放大/缩小）
✅ 自动保存（防抖 1 秒）

#### 6.4 卡片操作
✅ 新建卡片（双击画布）
✅ 编辑卡片（弹窗模式，Tiptap 富文本编辑器）
✅ 删除卡片（带确认，自动删除相关连线）
✅ 拖动卡片（自动保存位置）
✅ 颜色选择（3 种渐变色）
✅ 图片上传（base64 存储）

#### 6.5 主题切换
✅ 白天/黑夜模式切换
✅ 主题偏好持久化
✅ 初始化时读取系统偏好
✅ 所有组件响应主题变化
✅ 平滑过渡动画

### 七、优化与测试

#### 7.1 性能优化
✅ React Flow 性能配置（按需启用交互）
✅ 防抖保存（避免频繁写入）
✅ useMemo/useCallback 优化渲染

#### 7.2 交互优化
✅ 加载状态显示
✅ Toast 提示反馈
✅ 悬停动画
✅ 模态框动画
✅ 主题切换过渡

#### 7.3 数据持久化
✅ 笔记本数据持久化（localStorage）
✅ 画布数据持久化（IndexedDB）
✅ 刷新页面数据保留
✅ 删除笔记时清理画布数据

## 项目现状

### 已完成功能
- ✅ 登录页面：伪登录，主题切换，自动初始化示例数据
- ✅ 笔记架页面：网格布局，文件夹/笔记 CRUD，渐变封面，3D 文件夹图标，悬停动画
- ✅ 画布页面：无限画布，卡片 CRUD，连线功能，三种模式切换，富文本编辑器，颜色选择，图片上传
- ✅ 主题系统：白天/黑夜模式无缝切换，全局主题管理
- ✅ 数据持久化：笔记本数据（localStorage），画布数据（IndexedDB）
- ✅ 交互优化：Toast 提示，确认对话框，加载状态，动画过渡

### 待优化问题
- ⚠️ 卡片编辑模态框与原型图有差异（需要重新设计）
- ⚠️ 工具栏模式按钮过多（需要简化）
- ⚠️ 画布操作逻辑有待优化（模式切换、快捷键等）
- ⚠️ 部分图标样式需要调整

## 后续开发计划

### 阶段一：画布编辑器优化 (优先级：高)

#### 1.1 卡片编辑器重构
**目标**：根据原型图重新设计卡片编辑交互方式

**当前问题**：
- 当前采用模态框弹窗编辑，与原型图不符
- 原型图中应该是直接在卡片上进行内联编辑

**改进方案**：
- 实现卡片内联编辑模式（点击卡片进入编辑状态）
- 编辑时卡片自动展开，显示 Tiptap 编辑器
- 点击卡片外部或按 ESC 退出编辑模式
- 移除当前的 `CardEditModal` 弹窗组件
- 优化编辑器的布局和样式，符合原型图设计

**技术要点**：
- 在 `CardNode` 组件内集成编辑器
- 使用状态管理编辑模式（isEditing）
- 编辑时禁用画布拖动
- 自动保存编辑内容

#### 1.2 工具栏简化与优化
**目标**：精简画布工具栏，优化操作流程

**当前问题**：
- 工具栏按钮过多（选择/拖动/连线/新建卡片/居中等）
- 三种模式切换不够直观
- 部分功能使用频率低，占用工具栏空间

**改进方案**：
- **移除"拖动画布"模式按钮**：改为按住空格键临时进入拖动模式（类似 Figma）
- **合并模式按钮**：只保留"选择模式"和"连线模式"两个按钮
- **优化按钮布局**：
  - 左侧：返回按钮 + 笔记本名称
  - 中间：模式切换按钮组（选择/连线）
  - 右侧：新建卡片 + 居中 + 缩放控制 + 主题切换
- **添加快捷键提示**：悬停显示快捷键（如：空格拖动，V 选择，C 连线）

**技术要点**：
- 实现按住空格键临时切换到拖动模式
- 松开空格键恢复之前的模式
- 重新设计 `Toolbar` 组件布局
- 添加快捷键监听（useEffect + addEventListener）

#### 1.3 画布操作逻辑优化
**目标**：优化画布交互体验，提升操作效率

**改进项**：
- **双击卡片进入编辑**：替代当前的点击编辑按钮
- **拖拽创建卡片**：在画布上拖拽绘制卡片区域
- **右键菜单**：右键卡片显示操作菜单（编辑/删除/复制/改颜色）
- **框选多个卡片**：支持批量操作（移动/删除）
- **连线优化**：
  - 支持拖拽卡片边缘创建连线（替代连线模式）
  - 选中连线后可删除
  - 连线样式优化（贝塞尔曲线、箭头样式）
- **键盘快捷键**：
  - `V` - 选择模式
  - `C` - 连线模式
  - `Space` - 临时拖动画布
  - `Delete` - 删除选中的卡片/连线
  - `Cmd/Ctrl + Z` - 撤销（后续实现）
  - `Cmd/Ctrl + D` - 复制卡片（后续实现）

**技术要点**：
- 重构 `CanvasContainer` 的事件处理逻辑
- 添加右键菜单组件
- 实现快捷键系统（useKeyboard hook）
- 优化 React Flow 配置

#### 1.4 图标和界面细节优化
**目标**：提升视觉一致性和美观度

**优化项**：
- 统一图标风格（全部使用 Material Symbols Rounded）
- 调整按钮大小和间距
- 优化卡片阴影和毛玻璃效果
- 调整连线的颜色和粗细
- 优化小地图的样式
- 改进 Toast 提示的位置和动画

### 阶段二：笔记架功能完善 (优先级：中)

#### 2.1 文件夹过滤功能
- 点击文件夹时，笔记区域只显示该文件夹下的笔记
- 添加"全部笔记"选项，取消过滤
- 面包屑导航显示当前过滤状态

#### 2.2 搜索功能
- 实时搜索笔记和文件夹
- 支持模糊匹配
- 高亮搜索结果

#### 2.3 排序功能
- 按修改时间排序（默认）
- 按创建时间排序
- 按名称排序
- 按卡片数量排序

### 阶段三：卡片高级功能 (优先级：中)

#### 3.1 卡片调整大小
- 拖拽卡片边缘调整大小
- 最小/最大尺寸限制
- 调整大小时自动保存

#### 3.2 卡片复制
- 快捷键复制（Cmd/Ctrl + D）
- 右键菜单复制
- 复制后偏移位置

#### 3.3 卡片样式扩展
- 增加更多渐变色选项
- 支持纯色背景
- 支持自定义颜色

### 阶段四：撤销/重做系统 (优先级：低)

#### 4.1 历史记录管理
- 实现历史栈（基于 Immer）
- 记录所有可撤销操作（卡片移动、创建、删除、编辑等）
- 限制历史记录数量（如 50 条）

#### 4.2 快捷键实现
- `Cmd/Ctrl + Z` - 撤销
- `Cmd/Ctrl + Shift + Z` - 重做

### 阶段五：性能优化与细节打磨 (优先级：低)

#### 5.1 性能优化
- 大量卡片时的渲染优化
- 图片懒加载
- 虚拟滚动（笔记架）

#### 5.2 响应式适配
- 移动端适配
- 平板适配
- 触摸手势支持

#### 5.3 错误处理
- 网络错误提示
- 存储空间不足提示
- 数据损坏恢复

## 技术要点参考

### 空格键拖动实现示例
```typescript
// hooks/useSpaceDrag.ts
export function useSpaceDrag() {
  const [isSpacePressed, setIsSpacePressed] = useState(false);
  
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.code === 'Space' && !e.repeat) {
        setIsSpacePressed(true);
      }
    };
    
    const handleKeyUp = (e: KeyboardEvent) => {
      if (e.code === 'Space') {
        setIsSpacePressed(false);
      }
    };
    
    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, []);
  
  return isSpacePressed;
}
```

### 卡片内联编辑示例
```typescript
// components/Canvas/CardNode.tsx
const [isEditing, setIsEditing] = useState(false);

const handleDoubleClick = () => {
  setIsEditing(true);
};

return (
  <div onDoubleClick={handleDoubleClick}>
    {isEditing ? (
      <TiptapEditor 
        content={card.content}
        onSave={(content) => {
          updateCard(card.id, { content });
          setIsEditing(false);
        }}
      />
    ) : (
      <div dangerouslySetInnerHTML={{ __html: card.content }} />
    )}
  </div>
);
```

## 预计时间安排

- **阶段一（画布编辑器优化）**：约 4-5 小时
  - 卡片编辑器重构：1.5 小时
  - 工具栏简化：1 小时
  - 操作逻辑优化：1.5 小时
  - 图标界面优化：0.5 小时

- **阶段二（笔记架功能完善）**：约 2-3 小时
- **阶段三（卡片高级功能）**：约 2-3 小时
- **阶段四（撤销/重做系统）**：约 3-4 小时
- **阶段五（性能优化与细节打磨）**：约 2-3 小时

**总计**：约 13-18 小时

---

**备注**：本文档记录项目初始化完成后的实际状态和后续开发计划。
